<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
        <!--Import materialize.css-->
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
        <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
        <link href="css/style.css" rel="stylesheet" type="text/css" media="screen,projection"/>
        <link rel="stylesheet" href="css/intlTelInput.css">
        <script type="text/javascript" src='js/main.js'></script><script type="text/javascript" src="cordova.js"></script>
        <!--Let browser know website is optimized for mobile-->
    </head>

    <body class="grey lighten-4">
        <nav id="menu-add" class="grey lighten-4 navbar-fixed no-shadow"></nav>
        <div class="row padding-">
            <h5 class="col s12 center-align fo padding-tb-0 margin-top-0 margin-bottom-0">Buyer Profile</h5>                
        </div>
        <form id="login" action="kyc_c.html" data-parsley-validate novalidate class="margin-bottom-20">
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <span class="x-required" style="">*</span>
                    <input id="first_name" type="text" class="validate" placeholder="" name="first_name" required data-parsley-required-message="Please enter your first name">
                    <label for="first_name">First Name</label>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <span class="x-required" style="">*</span>
                    <input id="last_name" type="text" class="validate" placeholder="" name="last_name" required data-parsley-required-message="Please enter your last name">
                    <label for="last_name">Last Name</label>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <span class="x-required" style="">*</span>
                    <input id="company_name" placeholder="" type="text" class="validate" name="company_name" required data-parsley-required-message="Please enter your Company name">
                    <label for="company_name">Company Name</label>
                </div>
            </div>            
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <span class="x-required" style="">*</span>
                    <input id="email_id" type="email" placeholder="" readonly="" name="email_id" required data-parsley-required-message="Please enter your Email ID">
                    <label for="email">Email</label>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0" style="margin-bottom: 40px;width: 71%">
                    <span class="x-required" style="">*</span>
                    <input id="mobile_no" name="mobile_no" pattern="^[0-9+/ /]*$" maxlength="16" type="text" class="validate" placeholder="Mobile" required data-parsley-required-message="Please enter your Mobile Number">
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <span class="x-required" style="">*</span>
                    <div class="margin-top-10">Business Type</div>
                    <select class="browser-default" required="" id="business_type" name="business_type"></select>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <span class="x-required" style="">*</span>
                    <div class="margin-top-10">Nature of Business</div>
                    <select class="browser-default" required="" id="nature_business_type" name="nature_business_type">
                        <option value="">Select Nature of Business</option>
                        <option value="1">Dealer/Distributor</option>
                        <option value="2">Manufacturer</option>
                        <option value="3">Retailer</option>
                        <option value="4">Trader</option>
                        <option value="5">Others</option>
                    </select>                    
                </div>
            </div>
            <div class="row margin-bottom-0" style="margin-top: 40px;">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <span class="x-required" style="">*</span>
                    <textarea id="company_address" placeholder="" class="materialize-textarea" name="company_address"></textarea>
                    <label for="company_address">Company Address</label>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <span class="x-required" style="">*</span>
                    <div class="margin-top-10">Country</div>
                    <select class="browser-default" required="" id="country_id" name="country_id" data-parsley-required-message="Please select your country"></select>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <span class="x-required" style="">*</span>
                    <div class="margin-top-10">State</div>
                    <select class="browser-default" required="" id="state_id" name="state_id" data-parsley-required-message="Please select your state"></select>
                </div>
            </div>
            <div class="row margin-bottom-0 margin-top-10">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-10 ">
                    <span class="x-required" style="">*</span>
                    <input id="city" type="text" placeholder="" class="validate" name="city" required data-parsley-required-message="Please enter your city">
                    <label for="city">City</label>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-10 ">
                    <span class="x-required" style="">*</span>
                    <input id="pin_code" type="text" placeholder="" class="validate" name="pin_code" required data-parsley-required-message="Please enter your Pin Code">
                    <label for="pin_code">Pin Code</label>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-10 ">                    
                    <input id="pan_no" type="text" placeholder="" class="validate" name="pan_no">
                    <label for="pan_no">Pan No.</label>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-10 ">
                    <input id="cst_no" type="text" placeholder="" class="validate" name="cst_no">
                    <label for="cst_no">CST/VAT No.</label>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-bottom-20 margin-top-0">
                    <div class="margin-top-10">Dealing in which category</div>
                    <div class="dealing"></div>                    
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-bottom-20 margin-top-0">
                    <a class="waves-effect waves-light btn xstok darken-1" onClick="capturePhoto()"><i class="fa fa-camera"></i> Upload Visiting Card</a><span class="padding-lr-10 upload-succ"></span>
                </div>
            </div>
            <div class="row margin-bottom-0">
                <div class="col offset-s1 offset-m1 s10 m10 input-field margin-top-0 ">
                    <button class="btn waves-effect waves-light width-100p xstok darken-1" type="submit" name="action">Finish</button>
                </div>
            </div>            
        </form>
        <!--Import jQuery before materialize.js-->
        <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="js/materialize.min.js"></script>        
        <script type="text/javascript" src="js/intlTelInput.js"></script>
        <script type="text/javascript" src="js/utils.js"></script>
        <script type="text/javascript" src="js/parsley.min.js"></script>
        <script type="text/javascript" src="js/md5.js"></script>
        <script type="text/javascript">
            var pictureSource;   // picture source
            var destinationType;
            var retries = 0;
            function onDeviceReady() {
                //FastClick.attach(document.body);
                //pictureSource = navigator.camera.PictureSourceType;
                destinationType = navigator.camera.DestinationType;
                if (device.platform == "Android") {
                    // document.addEventListener("backbutton", onBackKeyDown, false);
                }
            }
            function clearCache() {
                navigator.camera.cleanup();
            }
            setTimeout(function () {
                onDeviceReady();
            }, 2000);
            function onCapturePhoto(fileURI) {
                $('#upload').addClass('disable');
                $('#upload').html('<i class="fa fa-refresh fa-spin x-white"></i> Uploading...');
                var win = function (r) {
                    clearCache();
                    retries = 0;
                    $('#upload').removeClass('disable');
                    $('#upload').html('<i class="fa fa-cloud-upload x-white"></i> Upload Visiting Card</a>');
                    $('.upload-succ').html('<i class="fa fa-check x-green fa-2x"></i>');
                    x_alert('Visiting Card Uploaded');

                }

                var fail = function (error) {
                    if (retries == 0) {
                        retries++;
                        setTimeout(function () {
                            onCapturePhoto(fileURI);
                        }, 1000);
                    } else {
                        retries = 0;
                        clearCache();
                        x_alert('Upload failed Please try again');
                        $('.upload-succ').html('<i class="fa fa-times x-red fa-2x"></i>');
                    }
                }

                var options = new FileUploadOptions();
                options.fileKey = "file";
                //options.fileName = fileURI.substr(fileURI.lastIndexOf('/') + 1);
                var filename = fileURI.substr(fileURI.lastIndexOf('/') + 1);
                var ext = filename.split('.')[1];
                if (typeof ext == 'undefined') {
                    ext = 'jpg';
                }
                options.fileName = filename + '.' + ext;
                var filename_full = filename + '.' + ext;
                options.mimeType = "image/jpeg";
                options.params = {}; // if we need to send parameters to the server request
                var ft = new FileTransfer();
                ft.upload(fileURI, encodeURI(localStorage.host + "visiting_card_upload_mobile.php?user_id=" + localStorage.user_id + "&visiting_card=" + filename_full + '&action=save'), win, fail, options);
            }
            function capturePhoto() {
                navigator.camera.getPicture(onCapturePhoto, onFail, {
                    quality: 100,
                    destinationType: Camera.DestinationType.FILE_URI
                });
            }

            function onFail(message) {
                //alert('Failed because: ' + message);
                $('.upload-succ').html('<i class="fa fa-times x-red fa-2x"></i>');
            }
            $("#mobile_no").intlTelInput({
                autoFormat: true,
                //autoHideDialCode: true,
                //nationalMode: true,
                // responsiveDropdown: true,
                utilsScript: "js/utils.js"
            });

            $(document).ready(function () {
                var country_id = 0;
                add_menu('',2, 1);
                $.ajax({url: localStorage.host + 'search_category.php', data: {}, type: 'get', success: function (data) {
                        var logininfo = JSON.parse(data);
                        var body = "";
                        for (var i = 0; i < logininfo['category'].length; i++) {
                            console.log(logininfo['category'][i]);
                            var lowername = logininfo['category'][i][1].toLowerCase().replace(' ', '_');
                            body += '<input type="checkbox" id="' + lowername + '" name="dealing_product[]" value="' + logininfo['category'][i][0] + '" class="checkbox' + logininfo['category'][i][0] + '" /><label for="' + lowername + '">' + logininfo['category'][i][1] + '</label><br>';
                        }
                        console.log(body);
                        $('.dealing').html(body);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        x_alert(localStorage.no_connection);
                        window.location.href = "no_connection.html";
                    }
                });
                $.ajax({url: localStorage.host + 'buyer_business_type_select.php', data: {}, type: 'get', success: function (data) {
                        var body_se = '<option value="">Select Business Type</option>';
                        console.log(data['result']);
                        for (var i = 0; i < data['result'].length; i++) {
                            body_se += '<option value="' + data['result'][i]['id'] + '">' + data['result'][i]['business_type_name'] + '</option>';
                        }
                        $('#business_type').html(body_se);
                        $('select').material_select();
                    }
                });
                $.ajax({url: localStorage.host + 'buyer_profile_select.php?id=' + rc4_dr(localStorage.user_id), data: {}, type: 'get', success: function (data) {
                        console.log(data['msg']);
                        $('input[name="company_name"]').val(localStorage.company_name);
                        $('input[name="name"]').val(data['msg'][0]['name']);
                        $('input[name="mobile_no"]').val(data['msg'][0]['mobile_no']);
                        $('input[name="email_id"]').val(data['msg'][0]['email_id']);
                        $('input[name="job_title"]').val(data['msg'][0]['title']);
                        $('input[name="department"]').val(data['msg'][0]['department']);
                        $('#business_type option[value="' + data['msg'][0]['business_type'] + '"]').prop('selected', true);
                        $('#nature_business_type option[value="' + data['msg'][0]['nature_business_type'] + '"]').prop('selected', true);
                        $('#company_address').html(data['msg'][0]['company_address']);
                        $('input[name="pan_no"]').val(data['msg'][0]['pan_no']);
                        $('input[name="cst_no"]').val(data['msg'][0]['cst_no']);
                        $('input[name="city"]').val(data['msg'][0]['city']);
                        if (data['msg'][0]['pin_code'] != 0)
                            $('input[name="pin_code"]').val(data['msg'][0]['pin_code']);
                        $('input[name="last_name"]').attr('value', data['msg'][0]['last_name']);
                        $('input[name="first_name"]').val(data['msg'][0]['first_name']);
                        country_id = data['msg'][0]['country_id'];
                        $.post(localStorage.host + '../classes/common.class.php?action=get_statte_list&c_=' + country_id + '', {id: country_id},
                        function (info) {
                            var items = [];
                            if (info) {
                                items.push("<option value=''>Select State Name</option>");
                                $.each($.parseJSON(info), function (idx, obj) {
                                    var select_s = '';
                                    if (data['msg'][0]['state_id'] == obj.id) {
                                        select_s = 'selected';
                                    }
                                    items.push("<option " + select_s + " value=" + obj.id + ">" + obj.state_name + "</option>");
                                });
                            }
                            $("select#state_id").html(items.join(""));
                        });
                        var type = data['msg'][0]['dealing_product'].split(',');
                        localStorage.dealing_product = data['msg'][0]['dealing_product'];
                        setTimeout(function () {
                            $.each(type, function (i, item) {
                                console.log('.checkbox' + item.trim());
                                //$('.checkbox' + item).prop(':checked', true);
                                $('.checkbox' + item.trim()).attr('checked', 'checked');
                            });
                        }, 0);

                        $("input[type='checkbox']").change(function () {
                            var dealing_product = [];
                            console.log('hehe');
                            $('input[type="checkbox"]').each(function () {
                                console.log('hehe1');
                                if ($(this).is(":checked")) {
                                    console.log('hehe2 ->' + $(this).attr('value'));
                                    dealing_product.push($(this).attr('value'));
                                }
                            });
                            localStorage.dealing_product = dealing_product;
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        x_alert(localStorage.no_connection);
                        window.location.href = "no_connection.html";
                    }
                });
                $.ajax({url: localStorage.host + '../classes/common.class.php?action=get_country_list', data: {}, type: 'get', success: function (data) {
                        var detail = JSON.parse(data);
                        var body = '<option value="">Select Country Name</option>';
                        for (var i = 0; i < detail.length; i++) {
                            var select = '';
                            if (typeof detail[i]['id'] !== 'undefined') {
                                if (country_id == detail[i]['id']) {
                                    select = 'selected';
                                }
                                body += '<option value="' + detail[i]['id'] + '" ' + select + '>' + detail[i]['country_name'] + '</option>';
                            }
                        }
                        $('#country_id').html(body);
                    }
                });
                $("select#country_id").change(function () {
                    var id = $("select#country_id option:selected").attr('value');
                    $.post(localStorage.host + '../classes/common.class.php?action=get_statte_list&c_=' + id + '', {id: id},
                    function (data) {
                        var items = [];
                        if (data) {
                            items.push("<option value=''>Select State Name</option>");
                            $.each($.parseJSON(data), function (idx, obj) {
                                items.push("<option value=" + obj.id + ">" + obj.state_name + "</option>");
                            });
                        }
                        $("select#state_id").html(items.join(""));
                    });
                });
                $("#login").submit(function (e) {
                    if ($('#login').parsley('isValid')) {
                        if (localStorage.dealing_product != '') {
                            $('button[type="submit"]').addClass('disable');
                            $('button[type="submit"]').html('Processing   <i class="fa fa-refresh fa-spin"></i>');
                            e.preventDefault();
                            var self = this;
                            var now = new Date();
                            now = new Date(now.toUTCString());
                            now = now + ' ';
                            var now_time = now.split(" ")[4];
                            var today = new Date();
                            var dd = today.getDate();
                            var mm = today.getMonth() + 1;
                            var yyyy = today.getFullYear();
                            if (dd < 10) {
                                dd = '0' + dd;
                            }
                            if (mm < 10) {
                                mm = '0' + mm;
                            }
                            var today = yyyy + '-' + mm + '-' + dd;
                            var date_ful = today + ' ' + now_time;
                            // var json = '{"id":"' + rc4_dr(localStorage.user_id) + '","email_id":"' + $('input[name="email_id"]').val() + '","admin_id":"' + rc4_dr(localStorage.user_id) + '","name":"' + $('input[name="name"]').val() + '","mobile_no":"' + $('input[name="mobile_no"]').val() + '","phone_no":"' + $('input[name="phone_no"]').val() + '","title":"' + $('input[name="job_title"]').val() + '","department":"' + $('input[name="department"]').val() + '","active":"Y","role_id":"3","action":"update","form_type":"FrontEnd"}';
                            //http://xstok.com/webservices/buyer_profile_update.php?json={"id":"8","company_id":"7","name":"Nitin Pandey","first_name":"Nitin","last_name":"Pandey","company_name":"Nitin Company","mobile_no":"9664242221","email_id":"nitin@ezcommindia.com","company_address":"Colaba Mumbai","country_id":"99","state_id":"3","city":"Mumbai","pin_code":"400005","business_type":"1","nature_business_type":"5","pan_no":"ASSER1232R","cst_no":"BDF343","dealing_product":"3","visiting_card":null,"now":"2015-08-24 15:54:00","action":"update","registration_type":"Buyer"}
                            ////{"id":"121","company_id":"120","name":"Shadab Shaikh","first_name":"Shadab","last_name":"Shaikh","company_name":"KLN","mobile_no":"+91 9819414708","email_id":"shadabs@centerac.com","company_address":"test","country_id":"99","state_id":"22","city":"Mumbai","pin_code":"400005","admin_id":"121","pan_no":"aaaaa1234a","business_type":"1","nature_business_type":"2","cst_no":"D10010","dealing_product":"1","now":"2015-08-25 11:09:57","action":"update","registration_type":"Buyer"}
                            //var date = new Date().toISOString().slice(0, 19).replace('T', ' ');                        
                            var json = '{"id":"' + rc4_dr(localStorage.user_id) + '","company_id":"' + localStorage.company_id + '","name":"' + $('input[name="first_name"]').val() + ' ' + $('input[name="last_name"]').val() + '","first_name":"' + $('input[name="first_name"]').val() + '","last_name":"' + $('input[name="last_name"]').val() + '","company_name":"' + $('input[name="company_name"]').val() + '","mobile_no":"' + $('input[name="mobile_no"]').val() + '","email_id":"' + $('input[name="email_id"]').val() + '","company_address":"' + $('#company_address').val() + '","country_id":"' + $('#country_id').val() + '","state_id":"' + $('#state_id').val() + '","city":"' + $('input[name="city"]').val() + '","pin_code":"' + $('input[name="pin_code"]').val() + '","admin_id":"' + rc4_dr(localStorage.user_id) + '","pan_no":"' + $('input[name="pan_no"]').val() + '","business_type":"' + $('#business_type :selected').val() + '","nature_business_type":"' + $('#nature_business_type :selected').val() + '","cst_no":"' + $('input[name="cst_no"]').val() + '","dealing_product":"' + localStorage.dealing_product + '","now":"' + date_ful + '","action":"update","registration_type":"Buyer"}';
                            console.log(json);
                            $.ajax({url: localStorage.host + 'buyer_profile_update.php', data: {json: json}, type: 'get', success: function (data) {
                                    $('button[type="submit"]').html('Done   <i class="fa fa-check"></i>');
                                    $('button[type="submit"]').removeClass('disable');
                                    setTimeout(function () {
                                        self.submit();
                                        return false;
                                    }, 700);
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    //  if (textStatus === "timeout") {
                                    x_alert(localStorage.no_connection);
                                    window.location.href = "no_connection.html";
                                    // }
                                }
                            });
                        } else {
                            x_alert('Please select dealing in which category');
                        }
                    }
                });
            });

        </script>
    </body>
</html>